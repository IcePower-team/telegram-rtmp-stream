name: Telegram RTMP Stream

on:
  workflow_dispatch:
  schedule:
    - cron: '*/50 * * * *'

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 55
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
    
    - name: Parse RTMP URL
      id: parse
      env:
        RTMP_URL: ${{ secrets.RTMP_URL }}
      run: |
        # تبدیل rtmps به rtmp و استخراج اطلاعات
        URL_WITHOUT_PROTOCOL=$(echo $RTMP_URL | sed 's|rtmps://||')
        echo "host=$URL_WITHOUT_PROTOCOL" >> $GITHUB_OUTPUT
    
    - name: Stream to Telegram
      env:
        RTMP_HOST: ${{ steps.parse.outputs.host }}
        STREAM_KEY: ${{ secrets.STREAM_KEY }}
      run: |
        # استریم مستقیم با TLS
        ffmpeg -re -loop 1 -framerate 25 -i Aramis.jpg \
               -stream_loop -1 -i music.mp3 \
               -c:v libx264 -preset ultrafast -tune zerolatency \
               -profile:v baseline -level 3.0 \
               -b:v 800k -maxrate 800k -bufsize 1600k \
               -vf "scale=1280:720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2,format=yuv420p,fps=25" \
               -g 50 -keyint_min 50 -sc_threshold 0 \
               -c:a aac -b:a 128k -ar 44100 -ac 2 \
               -f flv "rtmp://${RTMP_HOST}${STREAM_KEY}" || \
        ffmpeg -re -loop 1 -framerate 25 -i Aramis.jpg \
               -stream_loop -1 -i music.mp3 \
               -c:v libx264 -preset ultrafast -tune zerolatency \
               -profile:v baseline -level 3.0 \
               -b:v 600k -maxrate 600k -bufsize 1200k \
               -vf "scale=854:480:force_original_aspect_ratio=decrease,pad=854:480:(ow-iw)/2:(oh-ih)/2,format=yuv420p,fps=25" \
               -g 50 -keyint_min 50 -sc_threshold 0 \
               -c:a aac -b:a 96k -ar 44100 -ac 2 \
               -f flv "rtmp://${RTMP_HOST}${STREAM_KEY}"
