name: Telegram RTMP Stream

on:
  workflow_dispatch:  # اجرای دستی
  schedule:
    - cron: '*/50 * * * *'  # هر ۵۰ دقیقه restart میشه (برای جلوگیری از timeout)

jobs:
  stream:
    runs-on: ubuntu-latest
    timeout-minutes: 55  # بعد ۵۵ دقیقه خاموش میشه و دوباره شروع میشه
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
    
    - name: Install FFmpeg
      run: |
        sudo apt-get update
        sudo apt-get install -y ffmpeg
    
    - name: Stream to Telegram
      env:
        RTMP_URL: ${{ secrets.RTMP_URL }}
        STREAM_KEY: ${{ secrets.STREAM_KEY }}
      run: |
        # استریم بی‌نهایت با لوپ
        ffmpeg -re -loop 1 -i Aramis.jpg \
               -stream_loop -1 -i music.mp3 \
               -c:v libx264 -preset veryfast \
               -b:v 1000k -maxrate 1000k -bufsize 2000k \
               -vf "scale=1280:720:force_original_aspect_ratio=decrease,pad=1280:720:(ow-iw)/2:(oh-ih)/2,format=yuv420p" \
               -g 50 -c:a aac -b:a 128k -ar 44100 \
               -f flv "${RTMP_URL}${STREAM_KEY}"
